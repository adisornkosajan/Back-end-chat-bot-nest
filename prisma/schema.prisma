// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  USER
}

enum ConversationStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum PlanTier {
  TRIAL
  BASIC
  PRO
  ENTERPRISE
}

enum BroadcastStatus {
  draft
  scheduled
  paused
  sending
  sent
  failed
}

enum BroadcastRecipientStatus {
  pending
  sent
  failed
}


enum LicenseStatus {
  ACTIVE
  SUSPENDED
  EXPIRED
  CANCELED
}

enum PlatformRole {
  NONE
  OWNER
  SUPPORT_ADMIN
}

model User {
  id             String         @id @default(uuid())
  email          String         @unique
  passwordHash   String?
  name           String?
  organizationId String
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           UserRole       @default(USER)
  platformRole   PlatformRole   @default(NONE)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  notes          Note[]         // Notes created by this user
  noteEdits      NoteHistory[]  // Note edits made by this user
  summaryEdits   CustomerSummaryHistory[] // Customer summary edits made by this user

  @@map("users")
}

model Organization {
  id               String            @id @default(uuid())
  name             String
  address          String?           @db.Text
  contact          String?
  trn              String?
  description      String?           @db.Text
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  users            User[]
  platforms        Platform[]
  customers        Customer[]
  conversations    Conversation[]
  messages         Message[]
  invitations      Invitation[]
  notes            Note[]
  customerSummaries CustomerSummary[]
  quickReplies     QuickReply[]
  licenses         License[]
  invoices         Invoice[]
  tags             Tag[]
  broadcasts       Broadcast[]
  chatbotFlows     ChatbotFlow[]
  autoAssignRules  AutoAssignRule[]

  @@map("organizations")
}

model Platform {
  id             String         @id @default(uuid())
  organizationId String
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  type           String         // facebook, instagram, whatsapp
  pageId         String         // Platform-specific page/account ID
  accessToken    String         @db.Text // OAuth access token (can be very long)
  credentials    Json?          // Additional credentials if needed
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  customers      Customer[]
  conversations  Conversation[]

  @@unique([organizationId, type, pageId])
  @@map("platforms")
}

model Customer {
  id             String         @id @default(uuid())
  organizationId String
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  platformId     String
  platform       Platform       @relation(fields: [platformId], references: [id], onDelete: Cascade)
  externalId     String         // Platform-specific customer ID
  name           String?
  email          String?
  phone          String?
  metadata       Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  conversations  Conversation[]
  notes          Note[]
  customerTags   CustomerTag[]

  @@unique([platformId, externalId])
  @@map("customers")
}

model Conversation {
  id               String           @id @default(uuid())
  organizationId   String
  organization     Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  platformId       String
  platform         Platform         @relation(fields: [platformId], references: [id], onDelete: Cascade)
  customerId       String
  customer         Customer         @relation(fields: [customerId], references: [id], onDelete: Cascade)
  status           ConversationStatus @default(OPEN)
  assignedAgentId  String?          // Agent assigned to this conversation
  requestHuman     Boolean          @default(false) // Customer requested human agent
  firstResponseAt  DateTime?        // When agent first responded
  lastResponseAt   DateTime?        // Last agent response time
  activeFlowId     String?          // Currently active chatbot flow
  activeFlowNodeId String?          // Current node in the flow
  flowState        Json?            // Variables collected during flow
  flowResumeAt     DateTime?        // When to resume flow (for delays)
  lastMessageAt    DateTime         @default(now())
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  messages         Message[]
  notes            Note[]
  customerSummary  CustomerSummary? // One-to-one relation

  @@unique([platformId, customerId])
  @@map("conversations")
}

model Message {
  id                String       @id @default(uuid())
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  conversationId    String
  conversation      Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderType        String       // customer, agent, system
  platformMessageId String?
  content           String       @db.LongText // Support very long messages (up to 4GB)
  contentType       String       @default("text") // text, image, video, audio, file
  imageUrl          String?      @db.LongText // URL or base64 for image attachments
  rawPayload        Json?
  sentAt            DateTime     @default(now())
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@map("messages")
}

model Invitation {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  token          String       @unique
  role           String       @default("user") // user, ADMIN
  invitedBy      String       // User ID who sent the invitation
  status         String       @default("pending") // pending, accepted, expired, revoked
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([token])
  @@index([email])
  @@map("invitations")
}

model AIConfig {
  id             String       @id @default(uuid())
  organizationId String       @unique
  provider       String       @default("openai") // openai, anthropic, gemini
  model          String?      // gpt-4, gpt-3.5-turbo, claude-3-opus, gemini-pro, etc
  apiKey         String?      @db.Text // API key for the provider
  temperature    Float        @default(0.7)
  maxTokens      Int          @default(1000)
  systemPrompt   String?      @db.Text // Custom system prompt
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("ai_configs")
}

model Plugin {
  id             String       @id @default(uuid())
  organizationId String
  name           String       // Display name (e.g., "Salesforce", "HubSpot")
  type           String       // Plugin type (e.g., "crm", "analytics", "marketing")
  description    String?      @db.Text
  apiKey         String?      @db.Text // API credentials
  apiSecret      String?      @db.Text // API secret/password
  config         Json?        // Additional configuration (webhook URLs, settings, etc.)
  isActive       Boolean      @default(true)
  createdBy      String       // User ID who created this plugin
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@map("plugins")
}

model Note {
  id             String        @id @default(uuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  conversationId String?       // Optional: note for specific conversation
  conversation   Conversation? @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  customerId     String?       // Optional: note for specific customer
  customer       Customer?     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  content        String        @db.Text
  type           String        @default("general") // general, important, reminder, follow-up
  visibility     String        @default("internal") // internal, public
  tags           Json?         // Tags for categorizing notes (array of strings)
  isPinned       Boolean       @default(false) // Pin important notes to top
  createdBy      String        // User ID who created this note
  creator        User          @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  history        NoteHistory[] // History of edits

  @@index([organizationId])
  @@index([conversationId])
  @@index([customerId])
  @@index([createdBy])
  @@map("notes")
}

model NoteHistory {
  id             String   @id @default(uuid())
  noteId         String
  note           Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  content        String   @db.Text
  type           String
  editedBy       String
  editor         User     @relation(fields: [editedBy], references: [id], onDelete: Cascade)
  editedAt       DateTime @default(now())

  @@index([noteId])
  @@index([editedBy])
  @@map("note_history")
}

model CustomerSummary {
  id             String        @id @default(uuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  conversationId String        @unique // One summary per conversation
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  name           String?       // Customer name
  mobile         String?       // Mobile number
  email          String?       // Email address
  importantKey   String?       @db.Text // Important information/notes
  createdBy      String?       // User ID who created this summary
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  history        CustomerSummaryHistory[]

  @@index([organizationId])
  @@index([conversationId])
  @@map("customer_summaries")
}

model CustomerSummaryHistory {
  id           String          @id @default(uuid())
  summaryId    String
  summary      CustomerSummary @relation(fields: [summaryId], references: [id], onDelete: Cascade)
  name         String?
  mobile       String?
  email        String?
  importantKey String?         @db.Text
  editedBy     String
  editor       User            @relation(fields: [editedBy], references: [id], onDelete: Cascade)
  editedAt     DateTime        @default(now())

  @@index([summaryId])
  @@index([editedBy])
  @@map("customer_summary_history")
}

model QuickReply {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  shortcut       String       // e.g., "/hello", "/thanks", "/faq1"
  content        String       @db.Text // The actual message content
  category       String       @default("general") // greeting, closing, faq, support, sales, etc.
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, shortcut])
  @@index([organizationId])
  @@map("quick_replies")
}

model License {
  id              String        @id @default(uuid())
  organizationId  String
  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  licenseKey      String        @unique
  plan            PlanTier      @default(TRIAL)
  status          LicenseStatus @default(ACTIVE)
  seats           Int           @default(1)
  usedSeats       Int           @default(1)
  messageQuota    Int           @default(1000)
  messageUsed     Int           @default(0)
  periodStart     DateTime      @default(now())
  expiresAt       DateTime
  activatedAt     DateTime?
  suspendedReason String?
  createdBy       String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  invoices        Invoice[]

  @@index([organizationId, status])
  @@map("licenses")
}

model Invoice {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  licenseId      String?
  license        License?     @relation(fields: [licenseId], references: [id], onDelete: SetNull)
  provider       String
  providerRef    String?
  amountCents    Int
  currency       String       @default("THB")
  status         String       @default("pending") // pending, paid, failed, canceled
  periodStart    DateTime
  periodEnd      DateTime
  paidAt         DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId, status])
  @@index([providerRef])
  @@map("invoices")
}

// ===== CONTACT / CRM =====

model Tag {
  id             String        @id @default(uuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  color          String        @default("#3B82F6")
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  customerTags   CustomerTag[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("tags")
}

model CustomerTag {
  id         String   @id @default(uuid())
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  tagId      String
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([customerId, tagId])
  @@index([customerId])
  @@index([tagId])
  @@map("customer_tags")
}

// ===== BROADCAST / MASS MESSAGING =====

model Broadcast {
  id              String               @id @default(uuid())
  organizationId  String
  organization    Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name            String
  message         String               @db.Text
  imageUrl        String?              @db.Text
  platformType    String?              // facebook, instagram, whatsapp â€” null = all
  status          BroadcastStatus     @default(draft)
  scheduledAt     DateTime?
  timeZone        String?              @default("Asia/Bangkok") // Timezone for scheduling
  sentAt          DateTime?
  totalRecipients Int                  @default(0)
  sentCount       Int                  @default(0)
  failedCount     Int                  @default(0)
  filterTags      Json?                // Tag IDs to filter recipients
  createdBy       String
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  recipients      BroadcastRecipient[]

  @@index([organizationId])
  @@index([status])
  @@map("broadcasts")
}

model BroadcastRecipient {
  id          String    @id @default(uuid())
  broadcastId String
  broadcast   Broadcast @relation(fields: [broadcastId], references: [id], onDelete: Cascade)
  customerId  String
  platformId  String
  status BroadcastRecipientStatus @default(pending)
  sentAt      DateTime?
  error       String?   @db.Text
  createdAt   DateTime  @default(now())

  @@index([broadcastId])
  @@index([customerId])
  @@map("broadcast_recipients")
}

// ===== CHATBOT FLOW BUILDER =====

model ChatbotFlow {
  id              String   @id @default(uuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name            String
  description     String?  @db.Text
  isActive        Boolean  @default(false)
  triggerKeywords Json?    // Array of keywords that trigger this flow
  nodes           Json     // Array of flow nodes [{id, type, data, next}]
  createdBy       String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@index([isActive])
  @@map("chatbot_flows")
}

// ===== AUTO-ASSIGN RULE ENGINE =====

model AutoAssignRule {
  id              String   @id @default(uuid())
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name            String
  type            String   // keyword, platform, time_based, round_robin
  conditions      Json     // { keywords: [], platforms: [], timeRange: {start, end} }
  assignToAgentId String?  // null = round-robin among all agents
  priority        Int      @default(0) // higher = checked first
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([organizationId])
  @@index([isActive, priority])
  @@map("auto_assign_rules")
}
