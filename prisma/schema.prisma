// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MANAGER
  USER
}

model User {
  id             String         @id @default(uuid())
  email          String         @unique
  passwordHash   String?
  name           String?
  organizationId String
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           UserRole       @default(USER)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  notes          Note[]         // Notes created by this user
  noteEdits      NoteHistory[]  // Note edits made by this user

  @@map("users")
}

model Organization {
  id               String            @id @default(uuid())
  name             String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  users            User[]
  platforms        Platform[]
  customers        Customer[]
  conversations    Conversation[]
  messages         Message[]
  invitations      Invitation[]
  notes            Note[]
  customerSummaries CustomerSummary[]

  @@map("organizations")
}

model Platform {
  id             String         @id @default(uuid())
  organizationId String
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  type           String         // facebook, instagram, whatsapp
  pageId         String         // Platform-specific page/account ID
  accessToken    String         @db.Text // OAuth access token (can be very long)
  credentials    Json?          // Additional credentials if needed
  isActive       Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  customers      Customer[]
  conversations  Conversation[]

  @@unique([organizationId, type, pageId])
  @@map("platforms")
}

model Customer {
  id             String         @id @default(uuid())
  organizationId String
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  platformId     String
  platform       Platform       @relation(fields: [platformId], references: [id], onDelete: Cascade)
  externalId     String         // Platform-specific customer ID
  name           String?
  email          String?
  phone          String?
  metadata       Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  conversations  Conversation[]
  notes          Note[]

  @@unique([platformId, externalId])
  @@map("customers")
}

model Conversation {
  id               String           @id @default(uuid())
  organizationId   String
  organization     Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  platformId       String
  platform         Platform         @relation(fields: [platformId], references: [id], onDelete: Cascade)
  customerId       String
  customer         Customer         @relation(fields: [customerId], references: [id], onDelete: Cascade)
  status           String           @default("open") // open, closed, archived
  assignedAgentId  String?          // Agent assigned to this conversation
  requestHuman     Boolean          @default(false) // Customer requested human agent
  firstResponseAt  DateTime?        // When agent first responded
  lastResponseAt   DateTime?        // Last agent response time
  lastMessageAt    DateTime         @default(now())
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  messages         Message[]
  notes            Note[]
  customerSummary  CustomerSummary? // One-to-one relation

  @@unique([platformId, customerId])
  @@map("conversations")
}

model Message {
  id                String       @id @default(uuid())
  organizationId    String
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  conversationId    String
  conversation      Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderType        String       // customer, agent, system
  platformMessageId String?
  content           String       @db.LongText // Support very long messages (up to 4GB)
  contentType       String       @default("text") // text, image, video, audio, file
  rawPayload        Json?
  sentAt            DateTime     @default(now())
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@map("messages")
}

model Invitation {
  id             String       @id @default(uuid())
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  email          String
  token          String       @unique
  role           String       @default("user") // user, ADMIN
  invitedBy      String       // User ID who sent the invitation
  status         String       @default("pending") // pending, accepted, expired, revoked
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([token])
  @@index([email])
  @@map("invitations")
}

model AIConfig {
  id             String       @id @default(uuid())
  organizationId String       @unique
  provider       String       @default("openai") // openai, anthropic, gemini
  model          String?      // gpt-4, gpt-3.5-turbo, claude-3-opus, gemini-pro, etc
  apiKey         String?      @db.Text // API key for the provider
  temperature    Float        @default(0.7)
  maxTokens      Int          @default(1000)
  systemPrompt   String?      @db.Text // Custom system prompt
  isActive       Boolean      @default(true)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@map("ai_configs")
}

model Plugin {
  id             String       @id @default(uuid())
  organizationId String
  name           String       // Display name (e.g., "Salesforce", "HubSpot")
  type           String       // Plugin type (e.g., "crm", "analytics", "marketing")
  description    String?      @db.Text
  apiKey         String?      @db.Text // API credentials
  apiSecret      String?      @db.Text // API secret/password
  config         Json?        // Additional configuration (webhook URLs, settings, etc.)
  isActive       Boolean      @default(true)
  createdBy      String       // User ID who created this plugin
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([organizationId])
  @@map("plugins")
}

model Note {
  id             String        @id @default(uuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  conversationId String?       // Optional: note for specific conversation
  conversation   Conversation? @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  customerId     String?       // Optional: note for specific customer
  customer       Customer?     @relation(fields: [customerId], references: [id], onDelete: Cascade)
  content        String        @db.Text
  type           String        @default("general") // general, important, reminder, follow-up
  visibility     String        @default("internal") // internal, public
  tags           Json?         // Tags for categorizing notes (array of strings)
  isPinned       Boolean       @default(false) // Pin important notes to top
  createdBy      String        // User ID who created this note
  creator        User          @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  history        NoteHistory[] // History of edits

  @@index([organizationId])
  @@index([conversationId])
  @@index([customerId])
  @@index([createdBy])
  @@map("notes")
}

model NoteHistory {
  id             String   @id @default(uuid())
  noteId         String
  note           Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)
  content        String   @db.Text
  type           String
  editedBy       String
  editor         User     @relation(fields: [editedBy], references: [id], onDelete: Cascade)
  editedAt       DateTime @default(now())

  @@index([noteId])
  @@index([editedBy])
  @@map("note_history")
}

model CustomerSummary {
  id             String        @id @default(uuid())
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  conversationId String        @unique // One summary per conversation
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  name           String?       // Customer name
  mobile         String?       // Mobile number
  email          String?       // Email address
  importantKey   String?       @db.Text // Important information/notes
  createdBy      String?       // User ID who created this summary
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@index([organizationId])
  @@index([conversationId])
  @@map("customer_summaries")
}
